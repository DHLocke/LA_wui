---
title: "03_descriptives_EDA"
author: "Dexter H. Locke, PhD"
date: "`r format(Sys.time())`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This assumes "02_Woosley_combine_data.Rmd" was run



## 0 set up: load libraries, custom functions, set defaults
```{r}
# load libraries
# packages we'll be using
packs <- c('tidyverse'        # a must have!
           , 'tidylog'        # makes things very verbose for 2x checking 
           , 'magrittr'       # all of the pipes
           , 'janitor'        # cleans things up
           , 'sf'             # simple features
           , 'mapview'        # quick webmaps for zoom/pan viz
           #'tidycensus',     # access to Census data in a tidy way 
           #'party',          # random forests
           , 'tictoc'         # times things
           , 'beepr'          # makes noises
           , 'psych'          # describe is very useful for descriptive statistics
           , 'sjPlot')        # useful plotting and regression support

# check for all of the libraries
if (length(setdiff(packs, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packs, rownames(installed.packages())))  
}

lapply(packs, library, character.only = TRUE)


# changing from tidyr v0.8.3 -> v1.0.0 broke things for nest and unnest!
# https://tidyr.tidyverse.org/articles/in-packages.html#tidyr-v0-8-3---v1-0-0
library(tidyr)
nest <- nest_legacy                     # Why Hadley, WHY!
unnest <- unnest_legacy


# set custom function for getting spatial data
see_sf <- function(){
# what's in memory that are sf - spatial features?
keep(eapply(.GlobalEnv, class),      # gets the objects in the global environment
     ~ any(str_detect(., "sf"))) %>% # selects elements with sf in them
names(.) %>% as.character(.)       # my simple features
}

see_sf() -> sf_in_memory

## what are the spatial references of those SF classes?
mget(sf_in_memory) %>%
purrr::map(~st_crs(.x)$epsg) %>% unlist() #%>% View()

# NOT IN
`%nin%` <- Negate(`%in%`) # custom function

# where are we?
list.files()
list.files('data')

# parameter to keep in general, for later..
pxl_to_ft_conversion <- 0.75
# pxl_to_ft_conversion <- 0.2286004572

set.seed(19870630)

## Make a 'figures' subdirectory if one doesn't exist
# ifelse(!dir.exists(file.path('figures')), dir.create(file.path('figures')), FALSE)
```


## 1 read in the data
```{r}
build <- read_csv(paste0(getwd(), '/output_data/building_2021-03-24.csv'))
```



## 2 descriptive statistics
```{r}
build %>% describe #%>%
  # write_csv(., paste0(getwd(), '/output_data/describe_',               #doesn't have variable names, not a big deal but maybe want to change?
  #                     gsub('[[:punct:]]', '_', Sys.time()), '.csv'))   #Dexter, why are these Ns different? do we have total parcel size in our data set?

#some additional descriptive information/summaries
length(table(build$ID_Parcel)) #Dexter, I think this counts number of unique parcels
table(build$damage_cat)
table(build$build_structures_DAMAGE)
```


## 3 correlations
```{r}
# all
build %>% tidylog::select(build_Mean_elev_30m : parce_year_built) #%>% 
  # tab_corr(., file = paste0(getwd(), '/output_data/correlations_',
  # gsub('[[:punct:]]', '_', Sys.time()), '.html'))

# are the specific ones to look at?
 #Dexter, this is great! Here are some thoughts. I also made some notes in an excel file corrs.xlsx
 #do we have total parcel size in our data set? I think it might be worth checking out to see how it relates to other landscape measures and building age
 #elevation measures are highly correlated, not surprising
 #elevation of a building is related to land cover (higher elev has less road and building around but more veg- relationships differ w 10 vs 200 buffer)
 #build_min_dist_tree is missing I think bc of inf/Na?
 #build_min_dist_shrub correlated w elevation - wouldn't have thought that.
 #what is build_dist_angle?
 #what is build_dist_to_build_ft_jod? why not same as ours? sniff
 #tree overhang measures and 10 m are all pretty related
 #none of these are very strong corrs - but building age is related to landscape characteristics - older buildings are higher elev, farther from road, closer to shrub,have more tree overhang and more tree around building (less grass, less imperv). Older buildings are on parcels that have more tree and pervious cover, but less grass & building cover




```


## 4 missing values
```{r}
build %>% map(., ~sum(is.na(.)))

```



# 5 hists of land cover in buffers
```{r eval=FALSE, include=FALSE}

build %>% 
  #st_drop_geometry() %>% 
  tidylog::select(ID_Build, contains('build_p_')) %>% 
  pivot_longer(-ID_Build) %>% 
  mutate(#buff_dist = as.numeric(str_remove_all(name, '\\D')),
         var = str_remove(name, 'build_p_')) %>% 
  separate(var, into = c('var', 'buff_dist'), sep = '_', convert = TRUE) %>% 
  ggplot(aes(x = value)) + 
  # geom_density() + 
  geom_histogram() +
  #facet_wrap(~var + buff_dist, ncol = 4) +
  facet_grid(buff_dist ~ var) +
  theme_bw() + 
  ggsave(file = paste0(getwd(), '/figures/donut_buff_landcover_',
                    gsub('[[:punct:]]', '_', Sys.time()), '.png')) +
  NULL


build %>% ggplot(aes(build_min_dist_tree)) + geom_histogram(binwidth = 2)
build %>% ggplot(aes(build_min_dist_shrub)) + geom_histogram(binwidth = 2)

```




## 4 year built
```{r}
# YEAR BUILT
# build %>% map(., ~sum(is.na(.)))
# # Only living quarters are given a year built info
# build %>% 
#   tidylog::select(ID_Build, starts_with("parcel_Effective"), parcel_recent,
#            #, starts_with("parcel_YearBuilt")
#          ) %>% 
#   st_drop_geometry() %>% 
#   mutate_if(is.character, as.numeric) %>% #summary()
#   pivot_longer(cols = -ID_Build, names_to = 'variable') %>% 
#   ggplot(aes(value)) + 
#   geom_density() + 
#   facet_wrap(~variable, scales = 'free_x') + 
#   theme_bw()



# ggsave(file = paste0(getwd(), '/figures/effective_year_',
#                     gsub('[[:punct:]]', '_', Sys.time()), '.png'))

build %>% 
  select(starts_with("parcel_Effective"),
         # starts_with("parcel_YearBuilt"),
         parcel_recent) %>% map(., ~sum(is.na(.)))

# how many of these 
build %>%
  filter(parcel_Roll_ImpValue == 0 &
           parcel_Roll_HomeOwnersExemp == 0 &
           parcel_Build_P == 0) %>% # year built should be zero for these
  glimpse()

# where are these NA's?
build %>% filter(is.na(parcel_recent)) %>% mapview()
build %>% filter(parcel_recent == 0) %>% mapview()

summary(build$parcel_recent)

build %>% #st_drop_geometry() %>%
  ggplot(aes(parcel_recent)) +
  geom_histogram()

# ggsave(file = paste0(getwd(), '/figures/effective_yearRecent_',
#                     gsub('[[:punct:]]', '_', Sys.time()), '.png'))

# no longer needed, NA's zeros recoded in chunk above
# build %>% st_drop_geometry() %>% 
#   mutate(parcel_EffectiveYear1 = na_if(parcel_EffectiveYear1, 0)) %>% 
#   ggplot(aes(parcel_EffectiveYear1)) + geom_histogram()
# 
# ggsave(file = paste0(getwd(), '/figures/effective_yearONE_NO_ZERO',
#                     gsub('[[:punct:]]', '_', Sys.time()), '.png'))


glimpse(build)

box_plot_dat <- build %>% 
  select(damage_cat,
         starts_with('build_'),
         starts_with('parcel_'),
         -build_structures_DAMAGE, -parcel_AIN) %>% data.frame %>% glimpse

# for(i in 2:ncol(box_plot_dat)){
#   print(names(box_plot_dat)[i])
#   png(file = paste0(getwd(), '/figures/boxplot_', names(box_plot_dat)[i], '_',
#                     gsub('[[:punct:]]', '_', Sys.time()), '.png'))
#   boxplot(box_plot_dat[,i] ~ box_plot_dat$damage_cat, main = names(box_plot_dat)[i])
#   dev.off()
# }

```


TODO expand EDA
TODO descriptive statistics






### A a little prep
```{r}
# TODO handel the NA's better than dropping 11%
# a) manual fill, b) impute - see if it matters in the model
# see if year built is even a good predictor

# minor prep for binary 
build_bin <- build %>% 
  st_drop_geometry() %>% 
  select(damage_binary, build_Mean_elev_30m : build_Mean_distall_road,
         build_NEAR_DIST, build_NEAR_ANGLE,
         build_dist_to_build_ft : build_p_shrub_300,
         parcel_UseType: parcel_Imperv_P,
         parcel_recent) %>% 
  filter(parcel_recent > 0) %>% 
  drop_na() %>% 
  data.frame #%>% glimpse

# check for NA
map(build_bin, ~sum(is.na(.))) # check for NA's

build_bin %>% filter(parcel_recent == 0) %>% dim()

```




```{r, citations}
lapply(packs, citation)
```


Last knit on `r format(Sys.time())`


```{r}
system.time(save.image(file = paste0('saved_sessions/wui_r_desc_eda_', gsub('[[:punct:]]', '-', Sys.time()), '.RData')))
```

